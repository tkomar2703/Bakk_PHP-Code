<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="de" lang="de-de">
<head>
<title>Map | Testanwendung</title>


<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<meta http-equiv="content-script-type" content="text/javascript" />
<meta http-equiv="content-style-type" content="text/css" />
<meta http-equiv="content-language" content="de" />
<meta name="author" content="Thomas Heiles" />
<link rel="stylesheet" type="text/css" href="map.css"></link>
<!--[if IE]>
<link rel="stylesheet" type="text/css" href="ie_map.css"></link>
<![endif]-->
<script type="text/javascript" src="http://www.openlayers.org/api/OpenLayers.js"></script>
<script type="text/javascript" src="http://www.openstreetmap.org/openlayers/OpenStreetMap.js"></script>
<script type="text/javascript" src="tom.js"></script>


<script type="text/javascript">

var map;
var layer_mapnik;
var layer_tah;
var layer_markers;
var lonlat;
var js_lon2;

var polygonLayer;
var drawControls;
var control;
      var vectors;
      var box;
      var transform;
       
		function newPolygonAdded () {
			//alert('Polygon completed');
			//var coord = poly.features[0].geometry.getVertices();
			//alert("coord");
			poly.deactivate(); //stops the drawing
			var poly_coord = polygonLayer.features[0].geometry.getVertices();
			var anzahl = poly_coord.length;
			//alert(typeof(anzahl));
			var lon_punkt = new Array(anzahl);
			var lat_punkt = new Array(anzahl);
			for (var i = 0; i < anzahl; i++) {
				lon_punkt[i] = polygonLayer.features[0].geometry.getVertices()[i].x;
				lat_punkt[i] = polygonLayer.features[0].geometry.getVertices()[i].y;
			}
			
			//if (myPoint) {alert('test');}
			//else {alert('idiot');}
			//var myLatLonPoint = myPoint.transform( map.getProjectionObject(),
            //       new OpenLayers.Projection("EPSG:4326"));
			//var Ergebnis = poly_coord.match(/POINT/g);
			//if (Ergebnis) {
			//	for (var i = 0; i < Ergebnis.length; ++i) {
			//alert("Test 2: Fund " + i + " - " + Ergebnis[i]);} }
			//alert(typeof(poly_coord));
			//alert(typeof(myPoint));
			alert(anzahl);
			//alert(lat_punkt);
			
		}   	   
      
      function endDrag(bbox) {
      	var bounds = bbox.getBounds();
        setBounds(bounds);
        drawBox(bounds);
        box.deactivate();
        
        document.getElementById("bbox_drag_instruction").style.display = 'none';
        document.getElementById("bbox_adjust_instruction").style.display = 'block';        
      }
      
      function dragNewBox() {
        box.activate();
        transform.deactivate(); //The remove the box with handles
        vectors.destroyFeatures();
        
        document.getElementById("bbox_drag_instruction").style.display = 'block';
        document.getElementById("bbox_adjust_instruction").style.display = 'none';
        
        setBounds(null); 
      }
      
      function boxResize(event) {
        setBounds(event.feature.geometry.bounds);
      }
      
      function drawBox(bounds) {
        var feature = new OpenLayers.Feature.Vector(bounds.toGeometry());
 
        vectors.addFeatures(feature);
        transform.setFeature(feature);
      }
      
      function toPrecision(zoom, value) {
        var decimals = Math.pow(10, Math.floor(zoom/3));
        return Math.round(value * decimals) / decimals;
      }
      
      function setBounds(bounds) {
      	if (bounds == null) {
      	  document.getElementById("bbox_result").innerHTML = "";
      	  
      	} else {
          b = bounds.clone().transform(map.getProjectionObject(), new OpenLayers.Projection("EPSG:4326"))
          minlon = toPrecision(map.getZoom(), b.left);
          minlat = toPrecision(map.getZoom(), b.bottom);    
          maxlon = toPrecision(map.getZoom(), b.right);
          maxlat = toPrecision(map.getZoom(), b.top);  
                 
          document.getElementById("bbox_result").innerHTML =
                          "minlon=" + minlon + ", " +
                          "minlat=" + minlat + ", " +
                          "maxlon=" + maxlon + ", " +
                          "maxlat=" + maxlat;  
        
			document.getElementById("lat1").value = minlat;
			document.getElementById("lon1").value = minlon;
			
			document.getElementById("lat2").value = maxlat;
			document.getElementById("lon2").value = maxlon;
			
		
		
		
		}
      }

function error() { // für Benutzer Koordinatenabfrage
    alert("Die Positionsbestimmung ist Fehlgeschlagen!")
	var lon = 15;
	var lat = 47;
	var zoom = 7;
	jumpTo(lon, lat, zoom);
}   
         
function success(pos){ // für Benutzer Koordinatenabfrage
	var lon = pos.coords.longitude;
	var lat = pos.coords.latitude;
	var acc = pos.coords.accuracy;
	var zoom = 12;
	jumpTo(lon, lat, zoom); // zu Benutzerkoordinaten wechseln
	var popuptext="<font color=\"black\"><b>Derzeitige ungefähre Position</b><br>Geografische Länge: "+lon.toFixed(4)+" °<br>Geografische Breite: "+lat.toFixed(4)+" °<br>Genauigkeit: "+acc+" m</p></font>";
	addMarker(layer_markers, lon, lat, popuptext);
}       
         
function drawmap() { // OSM Karte erstellen

    OpenLayers.Lang.setCode('de');
     //               var wmsLayer = new OpenLayers.Layer.WMS( "OpenLayers WMS",
     //               "http://vmap0.tiles.osgeo.org/wms/vmap0?", {layers: 'basic'});
    map = new OpenLayers.Map('map', {
    projection: new OpenLayers.Projection("EPSG:900913"),
    displayProjection: new OpenLayers.Projection("EPSG:4326"),
    controls: [
        new OpenLayers.Control.Navigation(),
        //  new OpenLayers.Control.LayerSwitcher(),
		//	new OpenLayers.Control.MouseDefaults(),
		//	new OpenLayers.Control.Attribution(),
        new OpenLayers.Control.PanZoomBar()],
        maxExtent:
            new OpenLayers.Bounds(-20037508.34,-20037508.34,
                                    20037508.34, 20037508.34),
        numZoomLevels: 18,
        maxResolution: 156543,
        units: 'meters'
    });

    layer_mapnik = new OpenLayers.Layer.OSM.Mapnik("Mapnik");
    //layer_markers = new OpenLayers.Layer.Markers("Address", { projection: new OpenLayers.Projection("EPSG:4326"), 
    //	                                          visibility: true, displayInLayerSwitcher: false });
	
    //map.addLayers([layer_mapnik]);
	//map.addLayers([layer_mapnik, layer_markers]);
	//map.addControl(new OpenLayers.Control.MousePosition()); // Koordinaten rechts unten in der Karte
	
	                var pointLayer = new OpenLayers.Layer.Vector("Point Layer");
                var lineLayer = new OpenLayers.Layer.Vector("Line Layer");
                polygonLayer = new OpenLayers.Layer.Vector("Polygon Layer");
                var boxLayer = new OpenLayers.Layer.Vector("Box layer");

                map.addLayers([layer_mapnik, pointLayer, lineLayer, polygonLayer, boxLayer]);
               // map.addControl(new OpenLayers.Control.LayerSwitcher());
                map.addControl(new OpenLayers.Control.MousePosition());

              drawControls = {	
					polygon: poly = new OpenLayers.Control.DrawFeature(polygonLayer, OpenLayers.Handler.Polygon, 
                            {eventListeners:{"featureadded": newPolygonAdded}}),  
				};
				
                for(var key in drawControls) {
                    map.addControl(drawControls[key]);
                }  

				
				
	if (navigator.geolocation){
        navigator.geolocation.getCurrentPosition(success, error);	
	}
	else {
        alert("Geoortung wird nicht unterstützt!");
		var lon = 15;
		var lat = 47;
		var zoom = 7;
		jumpTo(lon, lat, zoom);
    }


	//click = new OpenLayers.Control.Click();
    //map.addControl(click);
	//click.activate();	
}	         
	
	
function bb() {
	    vectors = new OpenLayers.Layer.Vector("Vector Layer", {
        displayInLayerSwitcher: false
        });
        map.addLayer(vectors);
     
        box = new OpenLayers.Control.DrawFeature(vectors, OpenLayers.Handler.RegularPolygon, {
          handlerOptions: {
            sides: 4,
            snapAngle: 90,
            irregular: true,
            persist: true
          }
        });
        box.handler.callbacks.done = endDrag;
        map.addControl(box);
     
        transform = new OpenLayers.Control.TransformFeature(vectors, {
          rotate: false,
          irregular: true
        });
        transform.events.register("transformcomplete", transform, boxResize);
        map.addControl(transform);
        
        map.addControl(box);
        
        box.activate();
}

            function toggleControl(element) {
                for(key in drawControls) {
                    control = drawControls[key];
                    if(element.value == key) {
                        control.activate();						  
                    } else {
                        control.deactivate();
                    }
                }
            }
			

// Koordinaten aus Karte holen und in Felder eintragen
/*OpenLayers.Control.Click = OpenLayers.Class(OpenLayers.Control, {             
    defaultHandlerOptions: {
        'single': true,
        'double': false,
        'pixelTolerance': 0,
        'stopSingle': false,
        'stopDouble': false
    },

    initialize: function(options) {
        this.handlerOptions = OpenLayers.Util.extend(
        {}, this.defaultHandlerOptions
        );
        OpenLayers.Control.prototype.initialize.apply(
        this, arguments
        ); 
        this.handler = new OpenLayers.Handler.Click(
        this, {
        'click': this.trigger
        }, this.handlerOptions
        );
    }, 

    trigger: function(e) {
		// Von WGS84 in Mercator Projektion transformieren
		lonlat = map.getLonLatFromViewPortPx(e.xy).transform(new OpenLayers.Projection("EPSG:900913"), new OpenLayers.Projection("EPSG:4326"));
		if (document.bounding.punkt_ausw[0].checked == true) { // Koordinaten werden in Textfelder geschrieben
			var js_lat1 = lonlat.lat.toFixed(6);
			var js_lon1 = lonlat.lon.toFixed(6);
			document.getElementById("lat1").value = js_lat1;
			document.getElementById("lon1").value = js_lon1;
		}
		else {
			var js_lat2 = lonlat.lat.toFixed(6);
			var js_lon2 = lonlat.lon.toFixed(6);
			document.getElementById("lat2").value = js_lat2;
			document.getElementById("lon2").value = js_lon2;
		}	           
				
			// Bounding Box in Karte einzeichnen, wenn 2 Koordinatenpaare vorhanden
		if ((document.getElementById("lat2").value) != "" && (document.getElementById("lat1").value) != "" && (document.getElementById("lon2").value) != "" && (document.getElementById("lon1").value) != "") {					
			if (document.getElementById("lon1").value > document.getElementById("lon2").value) {
				var bb_lon1 = document.getElementById("lon2").value;
				var bb_lon2 = document.getElementById("lon1").value; 
			}
			else {
				var bb_lon1 = document.getElementById("lon1").value;
				var bb_lon2 = document.getElementById("lon2").value;
			}
							 
			if (document.getElementById("lat1").value > document.getElementById("lat2").value) {
				var bb_lat1 = document.getElementById("lat2").value;
				var bb_lat2 = document.getElementById("lat1").value;}
			else {
				var bb_lat1 = document.getElementById("lat1").value;
				var bb_lat2 = document.getElementById("lat2").value;
			}
			
			var box_extents = [[bb_lon1,bb_lat1,bb_lon2,bb_lat2]]; // Bounding Box Ecken festlegen
			var boxes  = new OpenLayers.Layer.Boxes('Boxes');
			
			for (var i = 0; i < box_extents.length; i++) {
				ext = box_extents[i];
				bounds = OpenLayers.Bounds.fromArray(ext);
				bounds.transform(new OpenLayers.Projection("EPSG:4326"), new OpenLayers.Projection("EPSG:900913"));
				box = new OpenLayers.Marker.Box(bounds);
				boxes.addMarker(box);
			}
					map.addLayers([boxes]);
		}
	}
}); */


//var click = document.getElementById('click'),
//    mousemove = document.getElementById('mousemove');

//var map = L.mapbox.map('map');

//map.on('mousemove click', function(e) {
//    window[e.type].innerHTML = e.containerPoint.toString() + ', ' + e.latlng.toString();
//});




//function selectBox() {
//    layer_vectors.destroyFeatures();
//    polygonControl.activate();
//}

//function Check() {
//  if (document.bounding.ZuTesten[0].checked == true) {
  	//alert (document.bounding.ZuTesten[0].value);
//    document.bounding.Eingabe.value = "Test 1";
//	var lonlat = map.getLonLatFromViewPortPx(e.xy).transform(new OpenLayers.Projection("EPSG:900913"), new OpenLayers.Projection("EPSG:4326"));
//	        document.getElementById("lat").value = lonlat.lat.toFixed(6);
 //           document.getElementById("lon").value = lonlat.lon.toFixed(6);
//
 // } else {
    //alert (document.bounding.ZuTesten[1].value);
//    document.bounding.Eingabe.value = "Test 2";
//  }
//}

//]]>
</script>
	
	
    <style>
    div.olControlAttribution { bottom:3px; }
    
    #bbox_drag_instruction { height:1.5em; }
    #bbox_adjust_instruction { height:1.5em; display:none;  }
	
	div.olControlMousePosition { 
		background-color: #000000; 
		font-weight: bold; 
	} 
    </style>
	
</head>
  <h2>OSM-Daten exportieren</h2>
  
<body onload="drawmap();">
 
<div id="header">
<div id="content">Karte (Testversion)</div>
<div id="osm">© <a href="http://www.openstreetmap.org">OpenStreetMap</a>
und <a href="http://www.openstreetmap.org/copyright">Mitwirkende</a>,
<a href="http://creativecommons.org/licenses/by-sa/2.0/deed.de">CC-BY-SA</a>
</div>
</div>

<div id='map'></div>

<h3>Bounding Box durch Koordinateneingabe oder durch Klick in die Karte:</h3>
<h4>bei Klick in die Karte: Radio Button entsprechend auswählen</h4>
<form name = "bounding" action = "ausfuehrung.php" method = "GET">
	<b>1. Punkt</b> <br/>
	<input type="radio" name="punkt_ausw" value="punkt1" checked="checked" onclick="Check()"></input>
	Geografische Länge:
	<input type="text" id="lon1" name="lon1" size="10" maxlength="10">
	Geografische Breite:
	<input type="text" id="lat1" name="lat1" size="10" maxlength="10"><br/>
	<b>2. Punkt</b> <br/>
	<input type="radio" name="punkt_ausw" value="punkt2" onclick="Check()"></input>
	Geografische Länge:
	<input type="text" id="lon2" name="lon2" size="10" maxlength="10">
	Geografische Breite:
	<input type="text" id="lat2" name="lat2" size="10" maxlength="10"><br/>
	
	<br/><b>Welche Elemente sollen beibehalten werden?</b> (Wenn nichts ausgewählt -> alles behalten)<br/>
	Wald:
	<input type="checkbox" name="tag[]" value="landuse=forest" ></input><br/>
	Straße:
	<input type="checkbox" name="tag[]" value="highway=" ></input><br/>
	Häuser:
	<input type="checkbox" name="tag[]" value="building=" ></input><br/>
	OSM-Filter: keep="Folgender Input" (mit obigen Optionen kombinierbar)<br/>
	<input type="text" id="keep_eig" name="keep_eig" size="50"><br/>
	<br/>OSM-Filter: Kompletten Befehl selbst schreiben (Achtung: Obige Optionen werden dabei ignoriert)<br/>
	<input type="text" id="befehl_eig" name="befehl_eig" size="50"><br/>
	<u>Beispiel:</u> ./osmfilter norway.osm <font color="#FF0000">--keep="highway=primary =secondary waterway=river"</font> -o=streets.osm<br/>
	Befehl in <font color="#FF0000">rot</font> selbst formulieren.<br/>
	Weitere Informationen: <a href="http://wiki.openstreetmap.org/wiki/DE:Osmfilter">OSM Wiki: OSM-Filter</a><br>
	
	<br/><b>Export als</b><br/>
	Shapefile (.shp):
	<input type="checkbox" name="typ[]" value="shp" checked="checked"></input><br/>
	OpenStreetMap-Datei (.osm):
	<input type="checkbox" name="typ[]" value="osm" ></input><br/>

	<br/><b>Exportierte Daten löschen?</b> (Auswahl in fertiger Arbeit nicht mehr vorhanden)<br/>
	Ja:
	<input type="radio" name="loeschen" value="loesch_ja" checked="checked"></input>
	Nein:
	<input type="radio" name="loeschen" value="loesch_nein" ></input><br/>
	<br/>
	<input type="submit" value="OK"\>
	<input type="reset" value="Abbrechen"\>
	<br/>(Mit Klick auf "OK" werden die Daten bereits runtergeladen)<br/>
	<b>Achtung: Je nach Größe der Bounding Box/Bounding Polygon kann die Verarbeitung mehrere Minuten oder Stunden dauern.<br/><br/><br/><br/>
</form>

	<input type="button" name="type" value="polygon" id="polygonToggle" onclick="toggleControl(this);" />
	<input type="button" value="drag a box" onclick="bb();"></div>
    <div id="bbox_drag_instruction">Drag a box:</div>
    <div id="bbox_adjust_instruction">Adjust the box ...or <input type="button" value="drag new box" onclick="dragNewBox();"></div>
    <div id="mapdiv"></div>
    <p id="bbox_result"> </p>
    <div id="explanation">Interface to let the user pick a bounding box, and adjust it</div>

</body>
</html>